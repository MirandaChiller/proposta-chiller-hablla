<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposta Comercial - Chiller Pe√ßas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        /* Loading Screen */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
        }

        #loading.hidden {
            display: none;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            background: white;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .container.visible {
            display: block;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
            color: white;
            padding: 40px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .company-logo {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
            margin-left: -15px;
        }

        .company-info {
            font-size: 12px;
            opacity: 0.9;
            line-height: 1.8;
        }

        .proposal-number {
            text-align: right;
        }

        .proposal-number h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .proposal-number .number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .proposal-date {
            font-size: 12px;
            opacity: 0.9;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 5px;
            background: #d4edda;
            color: #155724;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        /* Client Section */
        .client-section {
            padding: 30px 40px;
            background: #f8f9fa;
            border-left: 4px solid #0066cc;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #0066cc;
            margin-bottom: 15px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #0066cc;
            margin-right: 10px;
            display: inline-block;
            vertical-align: middle;
        }

        .client-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 11px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 3px;
        }

        .info-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        /* Items Table */
        .items-section {
            padding: 30px 40px;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .items-table thead {
            background: #0066cc;
            color: white;
        }

        .items-table th {
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .items-table tbody tr {
            border-bottom: 1px solid #e9ecef;
        }

        .items-table tbody tr:hover {
            background: #f8f9fa;
        }

        .items-table td {
            padding: 15px 12px;
            font-size: 13px;
        }

        .product-code {
            color: #0066cc;
            font-weight: 600;
        }

        .product-description {
            color: #333;
            line-height: 1.4;
        }

        /* Totals */
        .totals-section {
            padding: 30px 40px;
            background: #f8f9fa;
        }

        .totals-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
        }

        .payment-info {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .payment-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .payment-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 13px;
        }

        .payment-item .label {
            color: #6c757d;
        }

        .payment-item .value {
            font-weight: 500;
        }

        .totals-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        .total-row:last-child {
            border-bottom: none;
        }

        .total-row.final {
            background: #0066cc;
            color: white;
            padding: 15px;
            margin: 10px -20px -20px -20px;
            border-radius: 0 0 8px 8px;
            font-size: 18px;
            font-weight: bold;
        }

        /* Info Cards */
        .info-section {
            padding: 30px 40px;
        }

        .info-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .info-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 3px solid #0066cc;
        }

        .info-card-title {
            font-size: 12px;
            text-transform: uppercase;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .info-card-value {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            word-break: break-word;
        }

        /* Terms */
        .terms-section {
            padding: 30px 40px;
            background: #fff9e6;
            border-top: 2px solid #ffc107;
        }

        .terms-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .terms-title::before {
            content: '‚ö†Ô∏è';
            margin-right: 10px;
        }

        .terms-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ffe69c;
        }

        .terms-list {
            list-style: none;
            padding: 0;
        }

        .terms-list li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            font-size: 13px;
            line-height: 1.6;
        }

        .terms-list li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: #0066cc;
            font-weight: bold;
        }

        /* Call to Action - Compacto */
        .cta-section {
            padding: 20px 40px;
            background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
            text-align: center;
        }

        .cta-content {
            max-width: 900px;
            margin: 0 auto;
        }

        .cta-text-small {
            color: white;
            font-size: 13px;
            margin-bottom: 8px;
            opacity: 0.95;
            line-height: 1.4;
        }

        .cta-text-large {
            color: white;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin: 0;
            text-transform: uppercase;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
            line-height: 1.2;
        }

        /* Footer */
        .footer {
            background: #2c3e50;
            color: white;
            padding: 30px 40px;
            text-align: center;
        }

        .footer-content {
            font-size: 12px;
            line-height: 1.8;
        }

        .footer-highlight {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        /* Error Message */
        .error-message {
            max-width: 600px;
            margin: 100px auto;
            padding: 40px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            display: none;
        }

        .error-message.visible {
            display: block;
        }

        .error-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 24px;
            color: #dc3545;
            margin-bottom: 10px;
        }

        .error-text {
            color: #6c757d;
            margin-bottom: 20px;
        }

        /* Responsive - Mobile */
        @media (max-width: 768px) {
            /* Container */
            .container {
                margin: 0;
            }
            
            /* Header */
            .header {
                padding: 20px 15px;
            }
            
            .header-content {
                flex-direction: column;
            }
            
            .company-logo {
                font-size: 24px;
                margin-bottom: 8px;
                margin-left: -10px;
            }
            
            .company-logo img {
                height: 60px !important;
            }
            
            .company-info {
                font-size: 10px;
                line-height: 1.6;
            }
            
            .proposal-number {
                text-align: left;
                margin-top: 15px;
            }
            
            .proposal-number h1 {
                font-size: 18px;
            }
            
            .proposal-number .number {
                font-size: 28px;
            }
            
            .proposal-date {
                font-size: 11px;
            }
            
            .status-badge {
                font-size: 10px;
                padding: 4px 10px;
            }
            
            /* CTA Mobile */
            .cta-section {
                padding: 15px 15px;
            }
            
            .cta-text-large {
                font-size: 18px;
            }
            
            .cta-text-small {
                font-size: 11px;
                margin-bottom: 6px;
            }
            
            /* Se√ß√µes */
            .client-section,
            .items-section,
            .totals-section,
            .info-section,
            .terms-section,
            .footer {
                padding: 20px 15px;
            }
            
            .section-title {
                font-size: 16px;
                margin-bottom: 12px;
            }
            
            /* Client Grid */
            .client-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .info-label {
                font-size: 10px;
            }
            
            .info-value {
                font-size: 13px;
            }
            
            /* Tabela Mobile - Scroll Horizontal */
            .items-section {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .items-table {
                min-width: 800px;
                font-size: 11px;
            }
            
            .items-table th {
                padding: 8px 6px;
                font-size: 10px;
            }
            
            .items-table td {
                padding: 10px 6px;
                font-size: 11px;
            }
            
            .product-code {
                font-size: 11px;
            }
            
            .product-description {
                font-size: 11px;
            }
            
            /* Totais Mobile */
            .totals-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .payment-info,
            .totals-box {
                padding: 15px;
            }
            
            .payment-title {
                font-size: 13px;
            }
            
            .payment-item {
                font-size: 12px;
                padding: 6px 0;
            }
            
            .total-row {
                font-size: 13px;
                padding: 8px 0;
            }
            
            .total-row.final {
                font-size: 16px;
                padding: 12px;
            }
            
            /* Info Cards Mobile */
            .info-cards {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .info-card {
                padding: 15px;
            }
            
            .info-card-title {
                font-size: 10px;
            }
            
            .info-card-value {
                font-size: 13px;
            }
            
            /* Termos Mobile */
            .terms-title {
                font-size: 14px;
            }
            
            .terms-content {
                padding: 15px;
            }
            
            .terms-list li {
                font-size: 11px;
                line-height: 1.5;
                padding: 5px 0;
                padding-left: 20px;
            }
            
            /* Footer Mobile */
            .footer {
                padding: 20px 15px;
            }
            
            .footer-content {
                font-size: 11px;
            }
            
            .footer-highlight {
                padding: 12px;
                margin-top: 10px;
            }
            
            /* Bot√£o PDF Mobile */
            .print-button {
                top: 10px;
                right: 10px;
                padding: 8px 16px;
                font-size: 12px;
            }
            
            .print-icon {
                font-size: 16px;
            }
        }
        
        /* Mobile Pequeno (smartphones menores) */
        @media (max-width: 480px) {
            .company-logo {
                font-size: 20px;
                margin-left: -10px;
            }
            
            .company-logo img {
                height: 50px !important;
            }
            
            .company-info {
                font-size: 9px;
            }
            
            .proposal-number h1 {
                font-size: 16px;
            }
            
            .proposal-number .number {
                font-size: 24px;
            }
            
            .cta-text-large {
                font-size: 16px;
            }
            
            .cta-text-small {
                font-size: 10px;
            }
            
            .section-title {
                font-size: 14px;
            }
            
            .items-table {
                min-width: 700px;
            }
            
            /* Adicionar indicador de scroll */
            .items-section::after {
                content: '‚Üê Deslize para ver mais ‚Üí';
                display: block;
                text-align: center;
                font-size: 10px;
                color: #6c757d;
                margin-top: 10px;
                font-style: italic;
            }
        }

        /* Bot√£o Salvar PDF */
        .print-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .print-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }

        .print-button:active {
            transform: translateY(0);
        }

        .print-icon {
            font-size: 18px;
        }

        /* Bot√£o Aprovar Proposta */
        .approve-button {
            position: fixed;
            top: 70px;
            right: 20px;
            background: linear-gradient(135deg, #28a745 0%, #20923d 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .approve-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .approve-button:active:not(:disabled) {
            transform: translateY(0);
        }

        .approve-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.8;
        }

        .approve-button.loading {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        .approve-button.success {
            background: linear-gradient(135deg, #155724 0%, #0d3d1a 100%);
            box-shadow: 0 4px 15px rgba(21, 87, 36, 0.3);
        }

        .approve-button.error {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .approve-icon {
            font-size: 18px;
        }

        @media (max-width: 768px) {
            .print-button {
                top: 10px;
                right: 10px;
                padding: 10px 18px;
                font-size: 12px;
            }
            
            .approve-button {
                top: 60px;
                right: 10px;
                padding: 10px 18px;
                font-size: 12px;
            }
            
            .approve-icon {
                font-size: 16px;
            }
        }

        @media print {
            /* For√ßar impress√£o de cores de fundo */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            body {
                background: white;
                margin: 0;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                margin: 0;
                max-width: 100%;
            }
            
            #loading, .error-message, .print-button, .approve-button {
                display: none !important;
            }
            
            /* Ocultar CTA e Informa√ß√µes Adicionais no print */
            .cta-section,
            .info-section {
                display: none !important;
            }
            
            /* Header compacto mas leg√≠vel - MANT√âM BACKGROUND AZUL */
            .header {
                padding: 10px 15px;
                background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%) !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .company-logo {
                font-size: 18px;
                margin-bottom: 4px;
            }
            
            .company-logo img {
                height: 45px !important;
            }
            
            .company-info {
                font-size: 7px;
                line-height: 1.3;
            }
            
            .proposal-number h1 {
                font-size: 12px;
                margin-bottom: 2px;
            }
            
            .proposal-number .number {
                font-size: 18px;
                margin-bottom: 4px;
            }
            
            .proposal-date {
                font-size: 7px;
            }
            
            .status-badge {
                padding: 2px 6px;
                font-size: 7px;
                margin-top: 2px;
            }
            
            /* Se√ß√µes balanceadas */
            .client-section {
                padding: 8px 15px;
                background: #f8f9fa !important;
                border-left: 4px solid #0066cc !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .items-section {
                padding: 8px 15px;
                overflow: visible !important;
            }
            
            .items-table {
                width: 100% !important;
                min-width: auto !important;
                table-layout: fixed !important;
            }
            
            .totals-section {
                padding: 8px 15px;
                background: #f8f9fa !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .terms-section {
                padding: 8px 15px;
                background: #fff9e6 !important;
                border-top: 2px solid #ffc107 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .footer {
                padding: 8px 15px;
                background: #2c3e50 !important;
                color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .section-title {
                font-size: 11px;
                margin-bottom: 5px;
            }
            
            .section-title::before {
                height: 11px;
                margin-right: 4px;
            }
            
            /* Client grid em 3 colunas */
            .client-grid {
                gap: 4px;
                grid-template-columns: repeat(3, 1fr);
            }
            
            .info-label {
                font-size: 7px;
                margin-bottom: 1px;
            }
            
            .info-value {
                font-size: 9px;
            }
            
            /* Tabela leg√≠vel */
            .items-table thead {
                background: #0066cc !important;
                color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .items-table th {
                padding: 3px 2px;
                font-size: 7px;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            .items-table td {
                padding: 3px 2px;
                font-size: 8px;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            .product-code {
                font-size: 8px;
            }
            
            .product-description {
                font-size: 8px;
                line-height: 1.1;
            }
            
            /* Larguras das colunas - 9 colunas */
            .items-table th:nth-child(1),
            .items-table td:nth-child(1) {
                width: 10%;
            }
            
            .items-table th:nth-child(2),
            .items-table td:nth-child(2) {
                width: 25%;
            }
            
            .items-table th:nth-child(3),
            .items-table td:nth-child(3) {
                width: 6%;
            }
            
            .items-table th:nth-child(4),
            .items-table td:nth-child(4) {
                width: 10%;
            }
            
            .items-table th:nth-child(5),
            .items-table td:nth-child(5) {
                width: 8%;
            }
            
            .items-table th:nth-child(6),
            .items-table td:nth-child(6) {
                width: 9%;
            }
            
            .items-table th:nth-child(7),
            .items-table td:nth-child(7) {
                width: 8%;
            }
            
            .items-table th:nth-child(8),
            .items-table td:nth-child(8) {
                width: 9%;
            }
            
            .items-table th:nth-child(9),
            .items-table td:nth-child(9) {
                width: 15%;
            }
            
            /* Totais compactos */
            .totals-grid {
                gap: 10px;
                grid-template-columns: 1fr 280px;
            }
            
            .payment-info,
            .totals-box {
                padding: 6px;
            }
            
            .payment-title {
                font-size: 9px;
                margin-bottom: 4px;
            }
            
            .payment-item {
                padding: 2px 0;
                font-size: 8px;
            }
            
            .total-row {
                padding: 3px 0;
                font-size: 9px;
            }
            
            .total-row.final {
                padding: 6px;
                margin: 4px -6px -6px -6px;
                font-size: 11px;
                background: #0066cc !important;
                color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Termos compactos */
            .terms-title {
                font-size: 10px;
                margin-bottom: 4px;
            }
            
            .terms-content {
                padding: 6px;
            }
            
            .terms-list li {
                padding: 2px 0;
                padding-left: 14px;
                font-size: 7px;
                line-height: 1.3;
            }
            
            /* Footer compacto */
            .footer-content {
                font-size: 7px;
                line-height: 1.4;
            }
            
            .footer-highlight {
                padding: 4px;
                margin-top: 4px;
            }
            
            /* Evitar quebras de p√°gina */
            .header,
            .client-section,
            .items-section,
            .totals-section,
            .terms-section,
            .footer {
                page-break-inside: avoid;
            }
            
            /* P√°gina A4 com margens ajustadas */
            @page {
                size: A4;
                margin: 8mm;
            }
        }
    </style>
</head>
<body>
    <!-- Bot√£o Salvar PDF -->
    <button class="print-button" onclick="window.print()" title="Salvar como PDF ou Imprimir">
        <span class="print-icon">üñ®Ô∏è</span>
        <span>Salvar PDF</span>
    </button>

    <!-- Bot√£o Aprovar Proposta -->
    <button class="approve-button" id="approve-btn" onclick="approveProposal()" title="Aprovar esta proposta">
        <span class="approve-icon">‚úì</span>
        <span id="approve-text">Aprovar Proposta</span>
    </button>

    <!-- Loading Screen -->
    <div id="loading">
        <div style="text-align: center;">
            <div class="spinner"></div>
            <p style="margin-top: 20px; font-size: 18px;">Carregando proposta...</p>
        </div>
    </div>

    <!-- Error Message -->
    <div id="error" class="error-message">
        <div class="error-icon">‚ö†Ô∏è</div>
        <div class="error-title">Erro ao Carregar Proposta</div>
        <div class="error-text">
            N√£o foi poss√≠vel carregar os dados da proposta.<br>
            Verifique se o link est√° correto ou entre em contato com nosso suporte.
        </div>
        <p style="color: #6c757d; font-size: 12px; margin-top: 20px;">
            üìû (11) 2918-8119 | üìß contato@chillerpecas.com.br
        </p>
    </div>

    <!-- Main Container -->
    <div id="proposal-container" class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div>
                    <div class="company-logo">
                        <img src="https://i.imgur.com/krO2dWU.png" 
                             alt="Chiller Pe√ßas" 
                             style="height: 70px; width: auto; display: block;">
                    </div>
                    <div class="company-info">
                        CHILLER COM√âRCIO DE PE√áAS E ACESS√ìRIOS LTDA<br>
                        www.chillerpecas.com.br | #RE574.706-2017<br>
                        CNPJ: 35.028.609/0001-53 | IE: 126.847.127.115<br>
                        Rua Ant√¥nio de Barros, 1093 - Tatuap√©<br>
                        S√£o Paulo - SP - CEP: 03401-000<br>
                        Tel: (11) 2918-8119
                    </div>
                </div>
                <div class="proposal-number">
                    <h1>Proposta Comercial</h1>
                    <div class="number" id="proposal-id">#...</div>
                    <div class="proposal-date">
                        Gerada em: <span id="proposal-date">...</span><br>
                        Validade: 5 dias √∫teis
                        <div class="status-badge" id="proposal-status">Carregando...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Call to Action Compacto -->
        <div class="cta-section">
            <div class="cta-content">
                <p class="cta-text-small">Est√° pronto para economizar? Venha negociar com a gente e garanta a melhor oferta nos melhores produtos.</p>
                <h2 class="cta-text-large">AQUI N√ÉO PERDEMOS OR√áAMENTO!</h2>
            </div>
        </div>

        <!-- Client Information -->
        <div class="client-section">
            <div class="section-title">Informa√ß√µes do Cliente</div>
            <div class="client-grid">
                <div class="info-item">
                    <div class="info-label">Nome / Raz√£o Social</div>
                    <div class="info-value" id="client-name">...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">CPF / CNPJ</div>
                    <div class="info-value" id="client-document">...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Telefone</div>
                    <div class="info-value" id="client-phone">...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Status</div>
                    <div class="info-value" id="client-status">...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Contato</div>
                    <div class="info-value" id="contact-name">...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">WhatsApp</div>
                    <div class="info-value" id="client-whatsapp">...</div>
                </div>
            </div>
        </div>

        <!-- Items -->
        <div class="items-section">
            <div class="section-title">Itens da Proposta</div>
            
            <table class="items-table">
                <thead>
                    <tr>
                        <th>C√≥digo</th>
                        <th>Descri√ß√£o</th>
                        <th style="text-align: center;">Qtd</th>
                        <th style="text-align: right;">Valor Unit.</th>
                        <th style="text-align: right;">Desconto (%)</th>
                        <th style="text-align: right;">Desconto (R$)</th>
                        <th style="text-align: right;">Impostos (%)</th>
                        <th style="text-align: right;">Impostos (R$)</th>
                        <th style="text-align: right;">Valor Total</th>
                    </tr>
                </thead>
                <tbody id="products-table">
                    <!-- Products will be inserted here -->
                </tbody>
            </table>
        </div>

        <!-- Totals -->
        <div class="totals-section">
            <div class="totals-grid">
                <div class="payment-info">
                    <div class="payment-title">Condi√ß√µes de Pagamento</div>
                    <div class="payment-item">
                        <span class="label">Condi√ß√£o:</span>
                        <span class="value" id="payment-condition">...</span>
                    </div>
                    <div class="payment-item">
                        <span class="label">C√≥digo:</span>
                        <span class="value" id="payment-code">...</span>
                    </div>
                    <div class="payment-item">
                        <span class="label">Data Prevista:</span>
                        <span class="value" id="prediction-date">...</span>
                    </div>
                </div>

                <div class="totals-box">
                    <div class="total-row">
                        <span>Recorrente:</span>
                        <span id="total-recurring">R$ 0,00</span>
                    </div>
                    <div class="total-row">
                        <span>Desconto:</span>
                        <span style="color: #28a745;" id="total-discount">- R$ 0,00</span>
                    </div>
                    <div class="total-row">
                        <span>Frete:</span>
                        <span id="total-shipping">R$ 0,00</span>
                    </div>
                    <div class="total-row">
                        <span>Impostos:</span>
                        <span id="total-taxes">R$ 0,00</span>
                    </div>
                    <div class="total-row">
                        <span>Desconto Adicional:</span>
                        <span style="color: #28a745;" id="additional-discount">- R$ 0,00</span>
                    </div>
                    <div class="total-row final">
                        <span>VALOR TOTAL:</span>
                        <span id="total-value">R$ 0,00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Information -->
        <div class="info-section">
            <div class="section-title">Informa√ß√µes Adicionais</div>
            <div class="info-cards">
                <div class="info-card">
                    <div class="info-card-title">Vendedor</div>
                    <div class="info-card-value" id="seller-name">...</div>
                </div>
                <div class="info-card">
                    <div class="info-card-title">Email Vendedor</div>
                    <div class="info-card-value" id="seller-email">...</div>
                </div>
                <div class="info-card">
                    <div class="info-card-title">Telefone Vendedor</div>
                    <div class="info-card-value" id="seller-phone">...</div>
                </div>
                <div class="info-card">
                    <div class="info-card-title">ID Proposta</div>
                    <div class="info-card-value" id="proposal-full-id">...</div>
                </div>
                <div class="info-card">
                    <div class="info-card-title">Data Cria√ß√£o</div>
                    <div class="info-card-value" id="creation-date">...</div>
                </div>
                <div class="info-card">
                    <div class="info-card-title">Status</div>
                    <div class="info-card-value" id="proposal-status-text">...</div>
                </div>
            </div>
        </div>

        <!-- Terms -->
        <div class="terms-section">
            <div class="terms-title">Condi√ß√µes Gerais e Termos Importantes</div>
            <div class="terms-content">
                <ul class="terms-list">
                    <li><strong>Validade:</strong> Proposta v√°lida por 5 dias √∫teis, sujeita a confirma√ß√£o de estoque na data de aprova√ß√£o</li>
                    <li><strong>Formas de Pagamento:</strong> Transfer√™ncia banc√°ria (Ita√∫ 0341, Ag 0074, CC 99729-7), PIX (CNPJ 35.028.609/0001-53), boleto ou cart√£o de cr√©dito</li>
                    <li><strong>Prazo de Entrega:</strong> Frete e prazo sujeitos a altera√ß√µes conforme disponibilidade de estoque</li>
                    <li><strong>Garantia Legal:</strong> 90 dias corridos conforme CDC (Art. 26, inciso II) a partir da emiss√£o da NF</li>
                    <li><strong>Trocas/Devolu√ß√µes:</strong> N√£o aceitamos trocas por erro de informa√ß√µes na solicita√ß√£o</li>
                    <li><strong>Instala√ß√£o:</strong> A proposta n√£o contempla instala√ß√£o das pe√ßas</li>
                    <li><strong>Confirma√ß√£o:</strong> √â fundamental confirmar com o vendedor antes do envio da ordem de compra</li>
                </ul>
            </div>
        </div>

        <!-- Call to Action -->
        <!-- Footer -->
        <div class="footer">
            <div class="footer-content">
                <strong>CHILLER PE√áAS - Especialistas em Refrigera√ß√£o Industrial e Comercial</strong><br>
                Atendemos todo o Brasil com pe√ßas de qualidade e entregas r√°pidas
                
                <div class="footer-highlight">
                    <strong>üìû Central:</strong> (11) 2918-8119<br>
                    <strong>üìß Email:</strong> contato@chillerpecas.com.br<br>
                    <strong>üåê Site:</strong> www.chillerpecas.com.br
                </div>
            </div>
        </div>
    </div>

    <script>
        // Decode JWT token
        function decodeToken(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error('Error decoding token:', e);
                return null;
            }
        }

        // Format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value || 0);
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        // Format datetime
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR') + ' √†s ' + date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        // Format phone
        function formatPhone(phone) {
            if (!phone) return 'N/A';
            // Remove non-numeric characters
            phone = phone.replace(/\D/g, '');
            // Format Brazilian phone
            if (phone.length === 11) {
                return `(${phone.substring(0, 2)}) ${phone.substring(2, 7)}-${phone.substring(7)}`;
            } else if (phone.length === 10) {
                return `(${phone.substring(0, 2)}) ${phone.substring(2, 6)}-${phone.substring(6)}`;
            }
            return phone;
        }

        // Format document (CPF/CNPJ)
        function formatDocument(doc) {
            if (!doc) return 'N/A';
            doc = doc.replace(/\D/g, '');
            if (doc.length === 11) {
                // CPF
                return doc.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            } else if (doc.length === 14) {
                // CNPJ
                return doc.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
            }
            return doc;
        }

        // Translate status
        function translateStatus(status) {
            const statusMap = {
                'pending': 'Pendente',
                'approved': 'Aprovada',
                'rejected': 'Rejeitada',
                'in_attendance': 'Em Atendimento',
                'lead': 'Lead',
                'customer': 'Cliente',
                'prospect': 'Prospecto'
            };
            return statusMap[status] || status || 'N/A';
        }

        // Load proposal data
        async function loadProposal() {
            try {
                // Get token from URL
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');

                if (!token) {
                    throw new Error('Token n√£o encontrado na URL');
                }

                // Decode token to verify
                const tokenData = decodeToken(token);
                console.log('Token decoded:', tokenData);

                if (!tokenData || !tokenData.id) {
                    throw new Error('Token inv√°lido');
                }

                // Fetch data directly from Hablla unprotected endpoint
                console.log('Fetching proposal data from Hablla...');
                const response = await fetch(`https://api.hablla.com/v1/quotation?token=${token}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Proposal data received:', data);

                // Populate the template
                populateTemplate(data);

                // Hide loading, show container
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('proposal-container').classList.add('visible');

            } catch (error) {
                console.error('Error loading proposal:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.add('visible');
            }
        }

        // Populate template with data
        function populateTemplate(data) {
            // Header
            document.getElementById('proposal-id').textContent = `#${data.id || ''}`;
            document.getElementById('proposal-date').textContent = formatDateTime(data.created_at);
            
            const statusBadge = document.getElementById('proposal-status');
            statusBadge.textContent = translateStatus(data.status);
            if (data.status === 'pending') {
                statusBadge.classList.add('pending');
            }

            // Client
            document.getElementById('client-name').textContent = data.name || 'N/A';
            
            // CPF/CNPJ - tentar m√∫ltiplos caminhos poss√≠veis
            const cpfCnpj = data.persons?.[0]?.ssn || 
                           data.persons?.[0]?.document || 
                           data.persons?.[0]?.cpf || 
                           data.persons?.[0]?.cnpj ||
                           data.ssn ||
                           data.document ||
                           data.cpf ||
                           data.cnpj;
            
            // Debug log
            console.log('CPF/CNPJ encontrado:', cpfCnpj);
            console.log('Estrutura persons:', data.persons);
            
            document.getElementById('client-document').textContent = formatDocument(cpfCnpj);
            
            document.getElementById('client-phone').textContent = formatPhone(data.persons?.[0]?.phones?.[0]?.phone);
            document.getElementById('client-status').textContent = translateStatus(data.persons?.[0]?.customer_status);
            document.getElementById('contact-name').textContent = data.persons?.[0]?.name || 'N/A';
            document.getElementById('client-whatsapp').textContent = data.persons?.[0]?.phones?.[0]?.is_whatsapp ? 'Sim' : 'N√£o';

            // Products - CORRIGIDO
            const productsTable = document.getElementById('products-table');
            productsTable.innerHTML = '';

            if (data.products && data.products.length > 0) {
                data.products.forEach(product => {
                    const row = document.createElement('tr');
                    
                    // C√°lculos corretos
                    const unitPrice = product.price || 0;
                    const quantity = product.quantity || 1;
                    const subtotal = unitPrice * quantity;
                    
                    // Percentuais - multiplicar por 100 para exibi√ß√£o correta
                    const discountPercent = (product.discount_percent || 0) * 100;
                    const taxesPercent = (product.taxes_percent || 0) * 100;
                    
                    // Valores - se n√£o vier da API, calcular manualmente
                    const discountValue = product.discount_value || (subtotal * (product.discount_percent || 0));
                    const taxesValue = product.taxes_value || (subtotal * (product.taxes_percent || 0));
                    
                    // Total final do produto
                    const totalProduct = subtotal - discountValue + taxesValue;
                    
                    row.innerHTML = `
                        <td>
                            <div class="product-code">${product.sku || product.code || 'N/A'}</div>
                        </td>
                        <td>
                            <div class="product-description">${product.name || 'N/A'}</div>
                            ${product.description ? `<div style="font-size: 11px; color: #6c757d; margin-top: 3px;">${product.description}</div>` : ''}
                        </td>
                        <td style="text-align: center;">${quantity}</td>
                        <td style="text-align: right;">${formatCurrency(unitPrice)}</td>
                        <td style="text-align: right;">${discountPercent.toFixed(2)}%</td>
                        <td style="text-align: right; color: #28a745;">- ${formatCurrency(discountValue)}</td>
                        <td style="text-align: right;">${taxesPercent.toFixed(2)}%</td>
                        <td style="text-align: right;">${formatCurrency(taxesValue)}</td>
                        <td style="text-align: right;"><strong>${formatCurrency(totalProduct)}</strong></td>
                    `;
                    productsTable.appendChild(row);
                });
            } else {
                productsTable.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Nenhum produto encontrado</td></tr>';
            }

            // Payment
            document.getElementById('payment-condition').textContent = data.payment_interval?.description || 'N/A';
            document.getElementById('payment-code').textContent = data.payment_interval?.code || 'N/A';
            document.getElementById('prediction-date').textContent = formatDate(data.prediction_date);

            // Totals
            document.getElementById('total-recurring').textContent = formatCurrency(data.recurring_value);
            document.getElementById('total-discount').textContent = `- ${formatCurrency(data.discount_value)}`;
            document.getElementById('total-shipping').textContent = formatCurrency(data.shipping_value);
            document.getElementById('total-taxes').textContent = formatCurrency(data.taxes_value);
            document.getElementById('additional-discount').textContent = `- ${formatCurrency(data.additional_discount_value)}`;
            document.getElementById('total-value').textContent = formatCurrency(data.value);

            // Additional Info
            document.getElementById('seller-name').textContent = data.user?.name || 'N/A';
            document.getElementById('seller-email').textContent = data.user?.email || 'N/A';
            document.getElementById('seller-phone').textContent = formatPhone(data.user?.phone);
            document.getElementById('proposal-full-id').textContent = data.id || 'N/A';
            document.getElementById('creation-date').textContent = formatDate(data.created_at);
            document.getElementById('proposal-status-text').textContent = translateStatus(data.status);
            
            // Salvar dados globalmente para fun√ß√£o de aprova√ß√£o
            window.proposalData = data;
            
            // Configurar estado inicial do bot√£o de aprova√ß√£o
            const approveBtn = document.getElementById('approve-btn');
            const approveText = document.getElementById('approve-text');
            
            if (data.status === 'approved') {
                approveBtn.disabled = true;
                approveBtn.classList.add('success');
                approveText.textContent = '‚úì J√° Aprovada';
            }
        }

        // Fun√ß√£o para aprovar proposta
        async function approveProposal() {
            const button = document.getElementById('approve-btn');
            const buttonText = document.getElementById('approve-text');
            
            // 1. Validar status atual
            const currentStatus = window.proposalData?.status;
            if (currentStatus === 'approved') {
                alert('Esta proposta j√° foi aprovada!');
                return;
            }
            
            // 2. Confirmar com usu√°rio
            const confirmMessage = 'Deseja realmente aprovar esta proposta?\n\nEsta a√ß√£o atualizar√° o status no sistema Hablla.';
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // 3. Preparar dados
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (!token) {
                alert('Erro: Token n√£o encontrado na URL.');
                return;
            }
            
            const tokenData = decodeToken(token);
            
            // Buscar workspace_id de m√∫ltiplas fontes poss√≠veis
            const workspaceId = tokenData.workspace_id?.id || tokenData.workspace?.id;
            const quotationId = tokenData.id;
            
            if (!workspaceId || !quotationId) {
                console.error('Token data:', tokenData);
                alert('Erro: N√£o foi poss√≠vel identificar workspace ou proposta.\n\nVerifique o console para mais detalhes.');
                return;
            }
            
            console.log('Aprovando proposta:', {
                workspaceId,
                quotationId,
                endpoint: `https://api.hablla.com/v1/workspaces/${workspaceId}/quotation/${quotationId}`
            });
            
            // 4. Estado de loading
            button.disabled = true;
            button.classList.add('loading');
            buttonText.textContent = 'Aprovando...';
            
            try {
                // 5. Fazer requisi√ß√£o PATCH
                const response = await fetch(
                    `https://api.hablla.com/v1/workspaces/${workspaceId}/quotation/${quotationId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            status: 'approved'
                        })
                    }
                );
                
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    // 6. SUCESSO
                    button.classList.remove('loading');
                    button.classList.add('success');
                    buttonText.textContent = '‚úì Proposta Aprovada!';
                    
                    // Atualizar badge de status na tela
                    const statusBadge = document.getElementById('proposal-status');
                    if (statusBadge) {
                        statusBadge.textContent = 'Aprovada';
                        statusBadge.classList.remove('pending');
                    }
                    
                    const statusText = document.getElementById('proposal-status-text');
                    if (statusText) {
                        statusText.textContent = 'Aprovada';
                    }
                    
                    // Atualizar dados globais
                    if (window.proposalData) {
                        window.proposalData.status = 'approved';
                    }
                    
                    // Mensagem de sucesso
                    setTimeout(() => {
                        alert('‚úÖ Proposta aprovada com sucesso!\n\nO status foi atualizado no sistema Hablla.');
                    }, 300);
                    
                } else {
                    // 7. Erro HTTP
                    let errorData = {};
                    try {
                        errorData = await response.json();
                    } catch (e) {
                        console.error('Erro ao fazer parse do JSON de erro:', e);
                    }
                    
                    console.error('Erro na resposta:', {
                        status: response.status,
                        statusText: response.statusText,
                        errorData
                    });
                    
                    throw new Error(errorData.message || `Erro HTTP: ${response.status}`);
                }
                
            } catch (error) {
                // 8. Tratamento de erros
                console.error('Erro ao aprovar proposta:', error);
                
                button.classList.remove('loading');
                button.classList.add('error');
                buttonText.textContent = 'Erro ao aprovar';
                
                // Mensagem de erro espec√≠fica
                let errorMessage = 'N√£o foi poss√≠vel aprovar a proposta.';
                
                if (error.message.includes('401')) {
                    errorMessage += '\n\nToken expirado ou inv√°lido.';
                } else if (error.message.includes('403')) {
                    errorMessage += '\n\nVoc√™ n√£o tem permiss√£o para aprovar esta proposta.';
                } else if (error.message.includes('404')) {
                    errorMessage += '\n\nProposta n√£o encontrada.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage += '\n\nErro de conex√£o. Verifique sua internet.';
                } else {
                    errorMessage += '\n\n' + error.message;
                }
                
                alert('‚ùå ' + errorMessage);
                
                // Reabilitar bot√£o ap√≥s 3 segundos
                setTimeout(() => {
                    button.disabled = false;
                    button.classList.remove('error');
                    buttonText.textContent = 'Tentar Novamente';
                }, 3000);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', loadProposal);
    </script>
</body>
</html>
